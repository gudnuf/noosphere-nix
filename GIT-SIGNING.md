# Git Commit Signing with FIDO Keys

This configuration uses SSH signatures with FIDO2 hardware security keys for Git commit signing. This is simpler and more secure than traditional GPG signing.

## How It Works

1. **SSH-based signing**: Git uses `gpg.format = "ssh"` to sign commits with SSH keys
2. **FIDO2 hardware keys**: The SSH keys are `ed25519-sk` type, backed by hardware security keys
3. **Physical presence required**: Every signature requires touching the FIDO key
4. **Verification**: An `allowed_signers` file maps emails to public keys for verification

## Configuration Files

| File | Purpose |
|------|---------|
| `home/modules/git.nix` | Git signing configuration and allowed_signers |
| `home/modules/dev-tools.nix` | Installs `openssh` with FIDO2 support |
| `~/.ssh/id_ed25519_sk_*.pub` | FIDO-backed public keys |
| `~/.ssh/allowed_signers` | Generated by Nix, maps emails to keys |

**Note:** macOS's built-in SSH lacks proper FIDO2 library support. The Nix-installed `openssh` package includes `libfido2` and is required for signing to work.

## Current Setup

**Primary signing key**: `~/.ssh/id_ed25519_sk_1.pub`

The allowed_signers file is managed declaratively in `git.nix` and synced on rebuild.

## Adding a New FIDO Key

### Step 1: Generate the Key

Insert your FIDO device and run one of these commands:

**Option A: Touch-only (no PIN, recommended for convenience)**
```bash
ssh-keygen -t ed25519-sk -C "gudnuf21@proton.me" -f ~/.ssh/id_ed25519_sk_2
```
- Press Enter twice when asked for passphrase (no passphrase)
- Each signature requires only a touch
- ⚠️ Back up the private key file - it can't be recovered from device

**Option B: Resident key (requires device PIN, recoverable)**
```bash
ssh-keygen -t ed25519-sk -O resident -C "gudnuf21@proton.me" -f ~/.ssh/id_ed25519_sk_2
```
- Requires device PIN for every signature
- Key can be recovered from device with `ssh-keygen -K`
- Good for backup FIDO keys you rarely use

**Flags explained:**
- `-t ed25519-sk`: Ed25519 key backed by FIDO2 security key
- `-O resident`: Stores key handle on device (recoverable, but requires PIN)
- `-C`: Comment (usually your email)
- `-f`: Output filename

### Step 2: Add to Allowed Signers

Edit `home/modules/git.nix` and add the new public key to `allowed_signers`:

```nix
home.file.".ssh/allowed_signers".text = ''
  gudnuf21@proton.me sk-ssh-ed25519@openssh.com AAAA...existing_key... gudnuf21@proton.me
  gudnuf21@proton.me sk-ssh-ed25519@openssh.com AAAA...new_key... gudnuf21@proton.me
'';
```

Get your new public key with:
```bash
cat ~/.ssh/id_ed25519_sk_2.pub
```

### Step 3: (Optional) Switch Primary Signing Key

To change which key Git uses for signing, edit `git.nix`:

```nix
signing.key = "~/.ssh/id_ed25519_sk_2.pub";
```

### Step 4: Rebuild

```bash
nrs
```

### Step 5: Add to GitHub

For commits to show as "Verified" on GitHub:

1. Copy your public key: `cat ~/.ssh/id_ed25519_sk_1.pub | pbcopy`
2. Go to GitHub → Settings → SSH and GPG keys → New SSH key
3. Select "Signing Key" as the key type
4. Paste and save

## Verifying Signatures

```bash
# Verify a specific commit
git verify-commit HEAD

# Show signature info in log
git log --show-signature -1

# Verify all commits in a range
git log --show-signature main..HEAD
```

## Recovering Keys from FIDO Device

**Only works for resident keys** (generated with `-O resident`):

```bash
# Insert FIDO device, then:
ssh-keygen -K

# This creates id_ed25519_sk_rk and id_ed25519_sk_rk.pub in current directory
```

For non-resident keys (touch-only), the private key file IS the key - back it up securely.

## Troubleshooting

### "No such device" error
- Ensure FIDO key is inserted
- Try unplugging and reinserting

### Signature fails silently
- Check the key file exists: `ls ~/.ssh/id_ed25519_sk_1*`
- Verify Git config: `git config --get user.signingKey`

### "No principal matched" during verify
- Ensure email in commit matches email in allowed_signers
- Check allowed_signers exists: `cat ~/.ssh/allowed_signers`
- Rebuild to sync: `nrs`

### GitHub shows "Unverified"
- Ensure you added the **public key** as a **Signing Key** (not Authentication Key) on GitHub
- The email in your commits must match a verified email on GitHub

### "Enter PIN" prompt when you don't want PIN
- You generated a resident key (`-O resident`) which requires device PIN
- Regenerate without `-O resident` for touch-only operation
- See "Adding a New FIDO Key" section for both options

### "No FIDO SecurityKeyProvider specified"
- You're using macOS's built-in SSH which lacks FIDO2 support
- Ensure `openssh` and `libfido2` are in your Nix packages
- Verify Nix SSH is first in PATH: `which ssh` should show `/etc/profiles/per-user/.../bin/ssh`

## Why FIDO Keys?

| Benefit | Description |
|---------|-------------|
| **Hardware-bound** | Private key material never leaves the FIDO device |
| **Phishing-resistant** | Origin-bound, can't be used on fake sites |
| **No key management** | No GPG keyring, agents, or passphrases to manage |
| **Physical presence** | Every signature requires touching the key |
| **Flexible security** | Choose touch-only (convenient) or PIN+touch (max security) |
